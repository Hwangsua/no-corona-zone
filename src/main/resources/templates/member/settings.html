<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/common_layout}" th:with="activeTab='settings', title='cosns'">
<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link th:href="@{/css/member/settings.css}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jdenticon@3.0.1" defer></script>
    <script th:inline="javascript">

        function uploadProfileImage() {
            var form = $('#update-form')[0];
            var formData = new FormData(form);
            formData.append("profileImg", $("#profileImg")[0].files[0]);

            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");


            $.ajax({
                enctype: 'multipart/form-data',
                url: '/upload_image',
                type: 'POST',
                data: formData,
                dataType: 'json',
                contentType: false,
                processData: false,
                cache: false,
                defer: false,
                success: function (result) {
                    $('#profile-preview').attr('src', result.image);
                },
                error: function () {
                    alert('error');
                },
                beforeSend : function(xhr)
                {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
                    xhr.setRequestHeader(header, token);
                },
            });
        }

        $(document).ready(function () {
            if ([[${result}]]) {
                alert('저장 성공!');
            }
            let nicknameRegexCheck = true;
            let nicknameDuplicateCheck = false;
            $("#nickname").on('focus', function () {
                nicknameDuplicateCheck = false;
                nicknameRegexCheck = false;
            });
            $("#nickname").on('blur', function () {
                let nickname = $('#nickname').val();
                const nicknameRegex = /^[a-zA-Z가-힣]+[0-9a-zA-Z가-힣]{3,7}$/;
                if (nicknameRegex.test(nickname)) {
                    nicknameRegexCheck = true;
                }
            });
            $("#nicknameDuplicateCheck").click(function () {
                let nickname = $('#nickname').val();
                console.log(nickname);
                if (!nicknameRegexCheck) {
                    alert('닉네임은 영어 또는 한글로 시작하는 4자 이상 8자 이하여야합니다.');
                    return false;
                }
                $.ajax({
                    url: '/nicknameCk',
                    type: 'GET',
                    data: {'nickname': nickname},
                    contentType: 'application/json',
                    dataType: 'json',
                    success: function (result) {
                        alert(result.message);
                        nicknameDuplicateCheck = true;
                    },
                    error: function () {
                        alert('error');
                    }
                });
            });


            $('.settingComplete').click(function () {
                let password = $('#password').val();
                let passwordCheck = $('#passwordCk').val();
                if (password == '' || passwordCheck == '') {
                    alert('패스워드 입력하세요');
                    return false;
                }
                if (password != passwordCheck) {
                    alert('두 패스워드가 일치하지 않습니다.');
                    return false;
                }
                if (!nicknameDuplicateCheck) {
                    alert('닉네임 중복 확인해주세요.');
                    return false;
                }
            });

            $("#profileImg").change(function () {
                uploadProfileImage();
            });
        });
    </script>
</head>
<body>
<div layout:fragment="content">
    <div class="container">

        <!-- id, enctype 값 추가했습니다 -->
        <form th:action="@{/settings}" th:object="${memberImage}" method="post" name="settings"
              enctype="multipart/form-data" id="update-form">
            <div class="settings-header">
                <div class="header-item1">정보수정</div>
                <div class="header-item2">

                    <!--class값 btn-style 을 settingComplete 으로 이름 바꿨습니다 -->
                    <button class="settingComplete" type="submit">저장</button>
                </div>
            </div>
            <div class="hr"></div>
            <div class="none" style="visibility: hidden;height: 25px"></div>
            <div class="content">
                <div class="content-list">
                    <label for="email" class="content-name">아이디</label>
                    <div class="content-name-value">
                        <input type="text" class="form-control" id="email" name="email" th:value="${member.email}" disabled>
                    </div>
                </div>
                <div class="content-list">
                    <label for="nickname" class="content-name">닉네임</label>
                    <!-- id 추가했습니다-->
                    <div class="content-name-value" id="nicknameCheck" style="display: flex">
                        <input type="text" th:value="${member.nickname}" name="nickname" class="form-control"
                               id="nickname" style="width: 160px">

                        <!-- id값 nickname-duplicate-check에서 nicknameDuplicateCheck으로 바꿨습니다. -->
                        <button type="button" id="nicknameDuplicateCheck">중복확인</button>

                        <div class="check_font" id="nickname-check">

                        </div>
                    </div>
                </div>
                <div class="content-list">
                    <label for="password" class="content-name">비밀번호</label>
                    <div class="content-name-value">
                        <input type="password" name="password" class="form-control" id="password"
                               placeholder="비밀번호를 입력하세요.">
                    </div>
                </div>
                <div class="content-list">
                    <label for="passwordCk" class="content-name">비밀번호 확인</label>
                    <div class="content-name-value">

                        <!-- id값 password-ck에서 passwordCk 로 바꿨습니다. -->
                        <input type="password" name="userPwCk" class="form-control" id="passwordCk"
                               placeholder="비밀번호를 다시 입력하세요.">
                    </div>
                </div>
                <div class="content-list">
                    <label for="introduce" class="content-name">자기소개</label>
                    <div class="content-name-value">
                        <input type="text" name="introduce" class="form-control" id="introduce"
                               placeholder="내용을 입력해주세요">
                    </div>
                </div>
                <div class="content-list-small">
                    <span class="content-name">프로필 사진</span>
                </div>
                <div class="content-list content-img">
                    <div class="content-name">
                        <div class="profile" th:if="${(member?.profileImage?.filePath)!=null}">
                            <img id="profile-preview" th:src="@{${member?.profileImage?.filePath}}" width="75"
                                 height="75"/>
                        </div>
                        <div class="profile" th:if="${(member?.profileImage)==null}">
                            <svg data-jdenticon-value="user" th:text="${member.nickname}"
                                 width="75" height="75" class="rounded border bg-light"></svg>
                        </div>
                    </div>
                    <div class="content-name-value">
                        <label for="profileImg" class="upload-btn">upload</label>

                        <!-- name profileImg로 바꿨습니다-->
                        <input type="file" id="profileImg" class="form-control" accept="image/*" name="profileImg"
                               style="display:none"/>
                    </div>

                </div>
                <div class="content-list-small">
                    <span class="content-name">백신 여부 체크</span>
                </div>
                <div class="agree-box">
                    <input type="checkbox" name="certification" id="certification" th:value="true"> 예
                </div>

                <!-- 사진이 아닌, 체크박스로 수정해서 아래 코드는 삭제해도 될거같습니다 혹시 몰라 코드 남겨놓습니다.-->
                <!--        <div class="content-list content-img">-->
                <!--          <div class="content-name">-->
                <!--            <div class="vaccine"></div>-->
                <!--          </div>-->
                <!--          <div class="content-name-value">-->
                <!--            <label for="vaccine-img" class="upload-btn">upload</label>-->
                <!--            <input type="file" class="form-control"-->
                <!--                   id="vaccine-img" name="vaccine-img" style="display: none">-->
                <!--          </div>-->
                <!--        </div>-->
            </div>
        </form>
    </div>
</div>
</body>
</html>